<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SnakySnaky Pro</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #111; color: white; }
  canvas { background: #222; display: block; margin: 20px auto; }
  #game, #chat { margin-top: 20px; }
  #chatMessages { max-height: 200px; overflow-y: auto; background: #333; padding: 5px; }
  input, button { padding: 5px; margin: 2px; }
</style>
</head>
<body>

<h1>SnakySnaky Pro</h1>

<div id="game">
  <canvas id="canvas" width="400" height="400"></canvas>
  <h3>Счёт: <span id="score">0</span></h3>
  <h4>Таблица лидеров:</h4>
  <ul id="leaderboard"></ul>
</div>

<div id="chat">
  <h3>Чат</h3>
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Сообщение">
  <button onclick="sendMessage()">Отправить</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "ТВОЙ_API_KEY",
  authDomain: "ТВОЙ_PROJECT_ID.firebaseapp.com",
  projectId: "ТВОЙ_PROJECT_ID",
  storageBucket: "ТВОЙ_PROJECT_ID.appspot.com",
  messagingSenderId: "XXX",
  appId: "XXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Игра =====
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let snake = [{x:10,y:10}], dir = {x:1,y:0}, food = {x:15,y:15}, score=0;
document.getElementById('score').innerText = score;

document.addEventListener('keydown', e => {
  if(e.key==="ArrowUp" && dir.y==0) dir={x:0,y:-1};
  if(e.key==="ArrowDown" && dir.y==0) dir={x:0,y:1};
  if(e.key==="ArrowLeft" && dir.x==0) dir={x:-1,y:0};
  if(e.key==="ArrowRight" && dir.x==0) dir={x:1,y:0};
});

setInterval(gameLoop, 150);
loadLeaderboard();
loadChat();

function gameLoop(){
  let head = {x:snake[0].x+dir.x, y:snake[0].y+dir.y};
  snake.unshift(head);

  if(head.x==food.x && head.y==food.y){
    score++;
    document.getElementById('score').innerText = score;
    spawnFood();
    updateLeaderboard();
  } else snake.pop();

  if(head.x<0||head.y<0||head.x>=20||head.y>=20||snake.slice(1).some(s=>s.x==head.x&&s.y==head.y)){
    alert("Игра окончена! Счёт: "+score);
    snake=[{x:10,y:10}]; dir={x:1,y:0}; score=0;
  }

  draw();
}

function draw(){
  ctx.fillStyle="#222"; ctx.fillRect(0,0,400,400);
  ctx.fillStyle="lime"; snake.forEach(s=>ctx.fillRect(s.x*20,s.y*20,18,18));
  ctx.fillStyle="red"; ctx.fillRect(food.x*20,food.y*20,18,18);
}

function spawnFood(){
  food={x:Math.floor(Math.random()*20),y:Math.floor(Math.random()*20)};
}

// ===== Таблица лидеров =====
function updateLeaderboard(){
  // Генерируем случайный юзернейм
  let user = "Игрок"+Math.floor(Math.random()*10000);
  db.collection("leaderboard").add({name:user, score:score});
}

function loadLeaderboard(){
  db.collection("leaderboard").orderBy("score","desc").limit(5)
    .onSnapshot(snapshot=>{
      let html="";
      snapshot.forEach(doc=>{
        html+=`<li>${doc.data().name}: ${doc.data().score}</li>`;
      });
      document.getElementById('leaderboard').innerHTML = html;
    });
}

// ===== Чат =====
function sendMessage(){
  const msg = document.getElementById('chatInput').value;
  if(!msg) return;
  let user = "Игрок"+Math.floor(Math.random()*10000);
  db.collection("chat").add({
    user:user,
    message:msg,
    ts:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('chatInput').value="";
}

function loadChat(){
  db.collection("chat").orderBy("ts","asc")
    .onSnapshot(snapshot=>{
      let html="";
      snapshot.forEach(doc=>{
        const data=doc.data();
        html+=`<b>${data.user}:</b> ${data.message}<br>`;
      });
      document.getElementById('chatMessages').innerHTML=html;
      document.getElementById('chatMessages').scrollTop=10000;
    });
}
</script>
</body>
</html>
